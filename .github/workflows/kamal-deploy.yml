name: Kamal Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: .ruby-version
        bundler-cache: true
    - name: Tailscale Up
      uses: tailscale/github-action@v4
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        tags: tag:prodweb
        ping: docker01
    - uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    - name: Deploy command
      id: deploy
      run: bundle exec kamal deploy
      env:
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
        KAMAL_REGISTRY_USERNAME: ${{ secrets.DOCKER_REGISTRY_USER }}
        KAMAL_REGISTRY_PASSWORD: ${{ secrets.DOCKER_REGISTRY_KEY }}
        DATABASE_PROD_URL: ${{ secrets.DATABASE_PROD_URL }}
        RAILS_ENV: production

    - name: Notify on success
      if: success()
      run: |
        curl --request POST \
          --url https://api.courier.com/send \
          --header "Authorization: Bearer ${{ secrets.COURIER_API_KEY }}" \
          --header "Content-Type: application/json" \
          --data '{
            "message": {
              "to": {
                "email": "${{ secrets.NOTIFY_EMAIL }}",
                "phone_number": "${{ secrets.NOTIFY_PHONE }}"
              },
              "routing": {
                "method": "all",
                "channels": ["email", "sms"]
              },
              "content": {
                "title": "✅ Deploy Succeeded",
                "body": "micahmagruder.com deployed successfully from commit ${{ github.sha }} by ${{ github.actor }}"
              }
            }
          }'

    - name: Notify on failure
      if: failure()
      run: |
        curl --request POST \
          --url https://api.courier.com/send \
          --header "Authorization: Bearer ${{ secrets.COURIER_API_KEY }}" \
          --header "Content-Type: application/json" \
          --data '{
            "message": {
              "to": {
                "email": "${{ secrets.NOTIFY_EMAIL }}",
                "phone_number": "${{ secrets.NOTIFY_PHONE }}"
              },
              "routing": {
                "method": "all",
                "channels": ["email", "sms"]
              },
              "content": {
                "title": "❌ Deploy Failed",
                "body": "micahmagruder.com deploy FAILED for commit ${{ github.sha }} by ${{ github.actor }}. Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            }
          }'